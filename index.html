<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vakıa Suresi Sayaç Paneli</title>
<style>
:root { --bg:#1f1f2e; --text:#fff; --card:#2a2a3d; --btn:#5a5af0; --btn-hover:#7272ff; }
.light { --bg:#f2f2f7; --text:#222; --card:#fff; --btn:#4a4ae0; --btn-hover:#6a6aff; }
body { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; min-height:100vh; }
h1 { margin-top:25px; font-size:2.4rem; }
.card { background:var(--card); padding:20px; border-radius:15px; width:90%; max-width:500px; margin-top:20px; box-shadow:0 4px 12px #00000040; }
#sayac { font-size:3rem; text-align:center; margin-bottom:20px; }
button { padding:12px 22px; font-size:1.1rem; background:var(--btn); color:#fff; border:none; border-radius:10px; cursor:pointer; margin:6px; transition:0.3s; }
button:hover { background:var(--btn-hover); transform:scale(1.05); }
.tarih-item { background:var(--card); padding:12px; border-radius:10px; margin:6px 0; box-shadow:0 2px 6px #00000030; }
canvas { margin-top:20px; border-radius:15px; background:var(--card); padding:10px; }
</style>
</head>
<body>

<h1>Vakıa Suresi Sayaç Paneli</h1>

<div class="card">
    <div id="sayac">Yükleniyor...</div>
    <button id="arttir">Arttır</button>
    <button id="sifirla">Sıfırla</button>
    <button id="tema">Tema Değiştir</button>
    <button id="indir">Verileri İndir</button>
</div>

<div class="card" style="margin-top:20px;">
    <h2>Günlük Kayıtlar</h2>
    <div id="gunlukListe">Yükleniyor...</div>
</div>

<canvas id="grafik" width="400" height="200"></canvas>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyB3DHMr6V0F8AFbRs86CK4rU4asuHU84Go",
  authDomain: "vakia-dc1ca.firebaseapp.com",
  databaseURL: "https://vakia-dc1ca-default-rtdb.firebaseio.com",
  projectId: "vakia-dc1ca",
  storageBucket: "vakia-dc1ca.appspot.com",
  messagingSenderId: "786195799330",
  appId: "1:786195799330:web:dc9f0c1fdb588e2c7cd97b",
  measurementId: "G-WS4YLF6FLH"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const sayacRef = ref(db, "sayac/toplam");
const gunlukRef = ref(db, "sayac/gunluk");

const sayacDOM = document.getElementById("sayac");
const gunlukDOM = document.getElementById("gunlukListe");

// Güvenli anahtar için ISO format
const bugunKey = new Date().toISOString().split("T")[0];

// Türkçe gösterim için fonksiyon
function formatTurkce(tarihKey) {
  return new Date(tarihKey).toLocaleDateString("tr-TR", { day:"numeric", month:"long", year:"numeric" });
}

// --- Chart.js ---
const ctx = document.getElementById("grafik").getContext("2d");
let chart = new Chart(ctx, {
    type: 'bar',
    data: { labels: [], datasets:[{label:'Okuma Sayısı', data:[], backgroundColor:'#5a5af0'}]},
    options:{responsive:true, plugins:{legend:{display:false}}}
});

// --- Başlangıç Verisi Kontrolü ---
async function initData() {
    const sayacSnap = await get(sayacRef);
    const gunlukSnap = await get(gunlukRef);
    if (!sayacSnap.exists() || !gunlukSnap.exists()) {
        await set(ref(db,"sayac"), {toplam:0, gunluk:{}});
    }
}
initData();

// --- Gerçek Zamanlı Toplam Sayaç ---
onValue(sayacRef, snap => {
    sayacDOM.textContent = snap.exists() ? snap.val() : 0;
});

// --- Gerçek Zamanlı Günlük Kayıt ---
onValue(gunlukRef, snap => {
    gunlukDOM.innerHTML = "";
    let data = snap.exists() ? snap.val() : {};
    let tarihler = Object.keys(data).sort().reverse();
    tarihler.forEach(t => {
        gunlukDOM.innerHTML += `<div class="tarih-item"><b>${formatTurkce(t)}</b> → ${data[t]} okuma</div>`;
    });
    let tersTarihler = [...tarihler].reverse();
    chart.data.labels = tersTarihler.map(t => formatTurkce(t));
    chart.data.datasets[0].data = tersTarihler.map(t => data[t]);
    chart.update();
});

// --- Arttır Butonu ---
document.getElementById("arttir").addEventListener("click", async () => {
    const sayacSnap = await get(sayacRef);
    const gunlukSnap = await get(gunlukRef);
    let toplam = sayacSnap.exists()?sayacSnap.val():0;
    let gunluk = gunlukSnap.exists()?gunlukSnap.val():{};
    toplam++;
    gunluk[bugunKey] = (gunluk[bugunKey]||0)+1;
    set(ref(db,"sayac"), {toplam:toplam, gunluk:gunluk});
});

// --- Sıfırla Butonu ---
document.getElementById("sifirla").addEventListener("click", async () => {
    if(!confirm("Tüm sayacı ve günlük kayıtları sıfırlamak istediğinizden emin misiniz?")) return;
    set(ref(db,"sayac"), {toplam:0, gunluk:{}});
});

// --- Tema Butonu ---
document.getElementById("tema").addEventListener("click", () => {
    document.body.classList.toggle("light");
});

// --- JSON İndir ---
document.getElementById("indir").addEventListener("click", async () => {
    const sayacSnap = await get(sayacRef);
    const gunlukSnap = await get(gunlukRef);
    const veri = {toplam:sayacSnap.exists()?sayacSnap.val():0, gunluk:gunlukSnap.exists()?gunlukSnap.val():{}};
    const blob = new Blob([JSON.stringify(veri,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download="vakia_sayac_veri.json"; a.click();
});
</script>

</body>
</html>

